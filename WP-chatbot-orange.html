<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Chatbot Widget</title>
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse-glow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.4);
            }
            50% {
                transform: scale(1.03);
                box-shadow: 0 6px 20px rgba(var(--primary-rgb), 0.5);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typingDots {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== CSS CUSTOM PROPERTIES (THEME SYSTEM) ===== */
        :root {
            --primary-color: #FF4F8B;
            --secondary-color: #FF8A4F;
            --primary-rgb: 255, 79, 139;
            --secondary-rgb: 255, 138, 79;
            --success-color: #4caf50;
            --error-color: #f44336;
            --background-color: #fafafa;
            --text-color: #333;
            --light-text: #666;
            --border-color: #eee;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 10px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 20px;
            --border-radius-small: 8px;
            --transition: all 0.3s ease;
        }

        /* ===== CHATBOT TOGGLE BUTTON ===== */
        .chatbot-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            border: none;
            cursor: pointer;
            animation: pulse-glow 2.5s ease-in-out infinite;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chatbot-toggle:hover {
            animation: none;
            transform: scale(1.12);
            box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.6);
        }

        .chatbot-toggle:focus {
            outline: 2px solid rgba(var(--primary-rgb), 0.7);
            outline-offset: 2px;
            animation: none;
        }

        .chatbot-toggle svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        /* ===== CHAT WIDGET CONTAINER ===== */
        .chatbot-widget {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 10000;
            transform: scale(0) translateY(20px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chatbot-widget.open {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* ===== CHAT HEADER ===== */
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bot-avatar.header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-glow 3s ease-in-out infinite;
            border: 2px solid white;
            overflow: hidden;
            background-color: white;
            transition: var(--transition);
        }

        .bot-avatar.header-avatar:hover {
            animation: none;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .bot-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-info h3 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .online-status {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.failed {
            background: var(--error-color);
            animation: none;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .close-btn:focus {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 2px;
        }

        .close-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* ===== CHAT MESSAGES ===== */
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--background-color);
            min-height: 0;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 3px;
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            animation: messageSlide 0.3s ease-out;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .bot-avatar.message-avatar {
            background-color: #e9ecef;
            border: 1px solid #d1d1d1;
        }

        .user-message-avatar {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            border: 1px solid #1976d2;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Markdown styling */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 8px 0 4px 0;
            font-weight: 600;
        }

        .message-content h1 { font-size: 18px; }
        .message-content h2 { font-size: 16px; }
        .message-content h3 { font-size: 15px; }

        .message-content p {
            margin: 4px 0;
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 2px 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content blockquote {
            border-left: 3px solid #ddd;
            margin: 8px 0;
            padding-left: 12px;
            color: var(--light-text);
        }

        .bot-message .message-content {
            background: #e9ecef;
            color: var(--text-color);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-light);
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.2);
        }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator-message {
            display: flex;
            margin-bottom: 16px;
            animation: messageSlide 0.3s ease-out;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #e9ecef;
            color: var(--light-text);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-light);
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typingDots 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* ===== QUICK REPLIES ===== */
        .quick-replies {
            padding: 0 15px 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            flex-shrink: 0;
            min-height: 40px;
            background: var(--background-color);
            animation: fadeInUp 0.3s ease-out;
        }

        .quick-reply-btn {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .quick-reply-btn:hover, .quick-reply-btn:focus {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.2);
            outline: none;
        }

        .quick-reply-btn.close-style {
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .quick-reply-btn.close-style:hover, .quick-reply-btn.close-style:focus {
            background: var(--error-color);
            color: white;
        }

        /* ===== CHAT INPUT ===== */
        .chat-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 6px 12px;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .input-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
        }

        .attachment-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            color: #B0B0B0;
            border-radius: 50%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .attachment-btn:hover {
            background-color: #f0f0f0;
            color: #888;
            transform: scale(1.1);
        }

        .attachment-btn:focus {
            outline: 2px solid #B0B0B0;
            outline-offset: 2px;
        }

        .attachment-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .message-input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
            padding: 8px 0;
        }

        .message-input::placeholder {
            color: #999;
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .send-btn:hover, .send-btn:focus {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(var(--primary-rgb), 0.3);
            outline: none;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* ===== ERROR MESSAGE ===== */
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            padding: 10px 15px;
            border-radius: var(--border-radius-small);
            margin-bottom: 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-message svg {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            fill: #c62828;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 480px) {
            .chatbot-widget {
                bottom: 10px;
                left: 10px;
                right: 10px;
                width: auto;
                height: 70vh;
                max-height: 450px;
                border-radius: 15px;
            }

            .chatbot-toggle {
                bottom: 15px;
                right: 15px;
                width: 55px;
                height: 55px;
            }

            .chat-header {
                padding: 15px;
            }

            .header-info h3 {
                font-size: 16px;
            }

            .chat-input {
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Chat Toggle Button -->
    <button id="chatbot-toggle" class="chatbot-toggle" aria-label="Open chat">
        <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
    </button>

    <!-- Chat Widget -->
    <div id="chatbot-widget" class="chatbot-widget" role="dialog" aria-labelledby="chat-title" aria-modal="true" tabindex="-1">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="bot-avatar header-avatar">
                        <img id="header-bot-avatar" src="" alt="" aria-hidden="true">
                    </div>
                    <div class="header-info">
                        <h3 id="chat-title">Chat with AI</h3>
                        <div class="online-status">
                            <div class="status-dot" id="status-dot" aria-hidden="true"></div>
                            <span class="sr-only" id="status-text">Online</span>
                            <span id="status-message">Online</span>
                        </div>
                    </div>
                </div>
                <button class="close-btn" id="close-chat" aria-label="Close chat">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages" aria-live="polite" aria-atomic="true">
            <!-- Messages will be appended here -->
        </div>

        <!-- Quick Reply Buttons -->
        <div class="quick-replies" id="quick-replies">
            <!-- Quick replies will be appended here -->
        </div>

        <!-- Chat Input -->
        <div class="chat-input">
            <div class="input-container">
                <button class="attachment-btn" id="attachment-btn" aria-label="Attach file">
                    <svg viewBox="0 0 24 24">
                        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49"/>
                    </svg>
                </button>
                <input type="text" id="message-input" class="message-input" placeholder="Type your message..." aria-label="Type your message">
                <button class="send-btn" id="send-btn" aria-label="Send message">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Simple Markdown Parser for formatting bot messages
         */
        class MarkdownParser {
            static parse(text) {
                if (!text) return '';
                
                text = this.sanitizeHTML(text);
                
                return text
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/__(.*?)__/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/_(.*?)_/g, '<em>$1</em>')
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                    .replace(/^\* (.*$)/gim, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                    .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^(?!<[h|u|o|p|b])/gm, '<p>')
                    .replace(/(?<!>)$/gm, '</p>')
                    .replace(/<p><\/p>/g, '')
                    .replace(/<p>(<[h|u|o|b])/g, '$1')
                    .replace(/(<\/[h|u|o|b][^>]*>)<\/p>/g, '$1');
            }
            
            static sanitizeHTML(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        /**
         * Enhanced ChatBot Class with better architecture and customization
         */
        class ChatBot {
            constructor(config = {}) {
                this.config = this.mergeConfig(config);
                this.state = {
                    isOpen: false,
                    isTyping: false,
                    conversationMemory: [],
                    maxMemorySize: 10
                };
                
                this.elements = this.initializeElements();
                this.setupEventListeners();
                this.applyConfiguration();
                this.showInitialMessage();
                this.updateConnectionStatus('online');
            }

            /**
             * Merge user config with defaults
             * // this is backup if failed, Dont change it leave it like this 
             */
            mergeConfig(userConfig) {
                const defaultConfig = {
                    // UI Configuration
                    botName: 'AI Assistant',
                    botAvatarHeaderUrl: 'https://cdn-icons-png.flaticon.com/256/4712/4712027.png',
                    botAvatarMessageUrl: 'https://cdn-icons-png.flaticon.com/256/4712/4712027.png',
                    userAvatarUrl: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                    
                    // Theme Configuration
                    primaryColor: '#FF4F8B',
                    secondaryColor: '#FF8A4F',
                    
                    // Messages Configuration
                    initialMessage: "Hello! I'm your AI assistant. How can I help you today?",
                    initialQuickReplies: [
                        { text: "Ask a question", message: "I have a question" },
                        { text: "Get help", message: "I need help" },
                        { text: "Just chat", message: "Let's have a conversation" }
                    ],
                    
                    // API Configuration
                    // this is backup if failed, Dont change it leave it like this 
                    // actual API CONFIG is down line 1440
                    apiKey: 'YOUR_OPENROUTER_API_KEY_HERE',
                    apiUrl: 'https://openrouter.ai/api/v1/chat/completions',
                    model: 'mistralai/mistral-small-3.2-24b-instruct:free',
                    maxTokens: 500,
                    temperature: 0.7,
                    
                    // Behavior Configuration
                    enableAttachments: true,
                    enableMarkdown: true,
                    autoCloseOnOutsideClick: false,
                    showTypingIndicator: true,
                    errorRetryAttempts: 3
                };
                
                return { ...defaultConfig, ...userConfig };
            }

            /**
             * Initialize DOM elements
             */
            initializeElements() {
                return {
                    toggle: document.getElementById('chatbot-toggle'),
                    widget: document.getElementById('chatbot-widget'),
                    closeBtn: document.getElementById('close-chat'),
                    messageInput: document.getElementById('message-input'),
                    sendBtn: document.getElementById('send-btn'),
                    messagesContainer: document.getElementById('chat-messages'),
                    quickRepliesContainer: document.getElementById('quick-replies'),
                    attachmentBtn: document.getElementById('attachment-btn'),
                    headerTitle: document.getElementById('chat-title'),
                    headerAvatar: document.getElementById('header-bot-avatar'),
                    statusDot: document.getElementById('status-dot'),
                    statusText: document.getElementById('status-text'),
                    statusMessage: document.getElementById('status-message')
                };
            }

            /**
             * Apply user configuration to UI elements
             */
            applyConfiguration() {
                // Apply theme colors
                this.applyTheme();
                
                // Configure UI elements
                this.elements.headerTitle.textContent = `Chat with ${this.config.botName}`;
                
                // Set bot avatar with error handling
                this.elements.headerAvatar.src = this.config.botAvatarHeaderUrl;
                this.elements.headerAvatar.alt = `${this.config.botName} Avatar`;
                this.elements.headerAvatar.onerror = () => {
                    this.elements.headerAvatar.style.display = 'none';
                    this.elements.headerAvatar.parentElement.innerHTML = 'ðŸ¤–';
                    this.elements.headerAvatar.parentElement.style.fontSize = '20px';
                };
                
                // Configure attachment button visibility
                if (!this.config.enableAttachments) {
                    this.elements.attachmentBtn.style.display = 'none';
                }
            }

            /**
             * Apply theme colors using CSS custom properties
             */
            applyTheme() {
                const root = document.documentElement;
                root.style.setProperty('--primary-color', this.config.primaryColor);
                root.style.setProperty('--secondary-color', this.config.secondaryColor);
                
                // Convert hex to RGB for rgba usage
                const primaryRgb = this.hexToRgb(this.config.primaryColor);
                const secondaryRgb = this.hexToRgb(this.config.secondaryColor);
                
                if (primaryRgb) {
                    root.style.setProperty('--primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
                }
                if (secondaryRgb) {
                    root.style.setProperty('--secondary-rgb', `${secondaryRgb.r}, ${secondaryRgb.g}, ${secondaryRgb.b}`);
                }
            }

            /**
             * Convert hex color to RGB object
             */
            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            /**
             * Setup all event listeners with improved event handling
             */
            setupEventListeners() {
                // Toggle chat
                this.elements.toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleChat();
                });

                // Close chat
                this.elements.closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.closeChat();
                });

                // Send message
                this.elements.sendBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.sendMessage();
                });

                // Enter key to send
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Attachment handling
                if (this.config.enableAttachments) {
                    this.elements.attachmentBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.handleAttachment();
                    });
                }

                // Quick replies - Fixed event handling
                this.elements.quickRepliesContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (e.target.classList.contains('quick-reply-btn')) {
                        this.handleQuickReply(e.target);
                    }
                });

                // Prevent widget clicks from closing chat
                this.elements.widget.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                // Outside click to close (FIXED - only if enabled and more precise)
                if (this.config.autoCloseOnOutsideClick) {
                    document.addEventListener('click', (e) => {
                        // Only close if chat is open and click is truly outside
                        if (this.state.isOpen && 
                            !this.elements.widget.contains(e.target) && 
                            !this.elements.toggle.contains(e.target) &&
                            e.target !== this.elements.widget &&
                            e.target !== this.elements.toggle) {
                            this.closeChat();
                        }
                    });
                }

                // Escape key to close
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.state.isOpen) {
                        this.closeChat();
                    }
                });
            }

            /**
             * Handle quick reply button clicks
             */
            handleQuickReply(button) {
                const message = button.dataset.message || button.textContent;
                
                // Check for special close button
                if (button.classList.contains('close-style') || 
                    message.toLowerCase().includes('close') || 
                    message.toLowerCase().includes('end')) {
                    this.closeChat();
                    return;
                }
                
                if (message.trim()) {
                    this.addMessage(message.trim(), 'user');
                    this.processUserMessage(message.trim());
                    this.clearQuickReplies();
                    this.elements.messageInput.focus();
                }
            }

            /**
             * Toggle chat open/close state
             */
            toggleChat() {
                if (this.state.isOpen) {
                    this.closeChat();
                } else {
                    this.openChat();
                }
            }

            /**
             * Open the chat widget
             */
            openChat() {
                this.elements.widget.classList.add('open');
                this.elements.toggle.setAttribute('aria-label', 'Close chat');
                this.elements.widget.setAttribute('aria-hidden', 'false');
                this.state.isOpen = true;
                
                setTimeout(() => {
                    this.elements.messageInput.focus();
                    this.scrollToBottom();
                }, 350);
            }

            /**
             * Close the chat widget
             */
            closeChat() {
                this.elements.widget.classList.remove('open');
                this.elements.toggle.setAttribute('aria-label', 'Open chat');
                this.elements.widget.setAttribute('aria-hidden', 'true');
                this.elements.toggle.focus();
                this.state.isOpen = false;
            }

            /**
             * Send user message
             */
            async sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (message && !this.state.isTyping) {
                    this.addMessage(message, 'user');
                    this.elements.messageInput.value = '';
                    this.clearQuickReplies();
                    this.elements.sendBtn.disabled = true;
                    
                    await this.processUserMessage(message);
                    
                    this.elements.sendBtn.disabled = false;
                }
            }

            /**
             * Process user message and generate bot response
             */
            async processUserMessage(message) {
                try {
                    this.updateConnectionStatus('online');
                    
                    if (this.config.showTypingIndicator) {
                        this.showTypingIndicator();
                    }
                    
                    const botResponse = await this.callAPI(message);
                    
                    if (this.config.showTypingIndicator) {
                        this.hideTypingIndicator();
                    }
                    
                    this.addToMemory(message, botResponse);
                    this.addMessage(botResponse, 'bot');
                    this.showDefaultQuickReplies();
                    
                } catch (error) {
                    if (this.config.showTypingIndicator) {
                        this.hideTypingIndicator();
                    }
                    
                    this.handleAPIError(error);
                }
            }

            /**
             * Call the AI API
             */
            async callAPI(userMessage) {
                const messages = [
                    {
                        role: 'system',
                        content: `You are ${this.config.botName}, a helpful AI assistant. You should:
- Be friendly, professional, and helpful
- Keep responses concise and clear
- Use the conversation history to provide contextually relevant answers
- If you don't know something, admit it rather than guessing
- Always maintain a positive and supportive tone

Your main goal is to assist users and provide valuable information.`
                    },
                    ...this.state.conversationMemory,
                    {
                        role: 'user',
                        content: userMessage
                    }
                ];
                
                const response = await fetch(this.config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.config.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI Chatbot Widget'
                    },
                    body: JSON.stringify({
                        model: this.config.model,
                        messages: messages,
                        max_tokens: this.config.maxTokens,
                        temperature: this.config.temperature
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Request failed'}`);
                }
                
                const data = await response.json();
                
                if (!data.choices?.[0]?.message?.content) {
                    throw new Error('Invalid response format from API');
                }
                
                return data.choices[0].message.content;
            }

            /**
             * Add message to memory
             */
            addToMemory(userMessage, botResponse) {
                this.state.conversationMemory.push(
                    { role: 'user', content: userMessage },
                    { role: 'assistant', content: botResponse }
                );
                
                while (this.state.conversationMemory.length > this.state.maxMemorySize * 2) {
                    this.state.conversationMemory.shift();
                }
            }

            /**
             * Add message to chat display - FIXED user avatar issue
             */
            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = `message-avatar ${sender === 'bot' ? 'bot-avatar' : 'user-message-avatar'}`;
                
                if (sender === 'bot') {
                    const avatarImg = document.createElement('img');
                    avatarImg.src = this.config.botAvatarMessageUrl;
                    avatarImg.alt = `${this.config.botName} Avatar`;
                    avatarImg.onerror = () => {
                        avatarDiv.innerHTML = 'ðŸ¤–';
                        avatarDiv.style.fontSize = '16px';
                        avatarDiv.style.color = '#666';
                    };
                    avatarDiv.appendChild(avatarImg);
                } else {
                    // User avatar - using initials or emoji as fallback
                    const avatarImg = document.createElement('img');
                    avatarImg.src = this.config.userAvatarUrl;
                    avatarImg.alt = 'Your Avatar';
                    avatarImg.style.width = '100%';
                    avatarImg.style.height = '100%';
                    avatarImg.style.objectFit = 'cover';
                    
                    avatarImg.onerror = () => {
                        avatarDiv.innerHTML = 'U';
                        avatarDiv.style.fontSize = '14px';
                        avatarDiv.style.fontWeight = 'bold';
                        avatarDiv.style.color = 'white';
                        avatarDiv.style.display = 'flex';
                        avatarDiv.style.alignItems = 'center';
                        avatarDiv.style.justifyContent = 'center';
                    };
                    
                    avatarDiv.appendChild(avatarImg);
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (sender === 'bot' && this.config.enableMarkdown) {
                    contentDiv.innerHTML = MarkdownParser.parse(text);
                } else {
                    contentDiv.textContent = text;
                }
                
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
                
                this.elements.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            /**
             * Show typing indicator
             */
            showTypingIndicator() {
                this.hideTypingIndicator();
                this.state.isTyping = true;
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator-message';
                typingDiv.id = 'typing-indicator';
                typingDiv.setAttribute('role', 'status');
                typingDiv.setAttribute('aria-label', `${this.config.botName} is typing`);

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar bot-avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = this.config.botAvatarMessageUrl;
                avatarImg.alt = `${this.config.botName} Avatar`;
                avatarImg.onerror = () => {
                    avatarDiv.innerHTML = 'ðŸ¤–';
                    avatarDiv.style.fontSize = '16px';
                    avatarDiv.style.color = '#666';
                };
                avatarDiv.appendChild(avatarImg);

                const indicatorDiv = document.createElement('div');
                indicatorDiv.className = 'typing-indicator';
                indicatorDiv.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;

                typingDiv.appendChild(avatarDiv);
                typingDiv.appendChild(indicatorDiv);
                this.elements.messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            /**
             * Hide typing indicator
             */
            hideTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
                this.state.isTyping = false;
            }

            /**
             * Show initial message and quick replies
             */
            showInitialMessage() {
                this.addMessage(this.config.initialMessage, 'bot');
                this.showQuickReplies(this.config.initialQuickReplies);
            }

            /**
             * Show default quick replies after bot response
             */
            showDefaultQuickReplies() {
                const defaultReplies = [
                    { text: "Tell me more", message: "Can you provide more details about that?" },
                    { text: "Thank you", message: "Thank you for your help!" },
                    { text: "Close chat", message: "close", isClose: true }
                ];
                this.showQuickReplies(defaultReplies);
            }

            /**
             * Show quick reply buttons
             */
            showQuickReplies(replies) {
                this.clearQuickReplies();
                
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.className = 'quick-reply-btn';
                    button.textContent = reply.text;
                    button.dataset.message = reply.message || reply.text;
                    
                    if (reply.isClose || reply.text.toLowerCase().includes('close')) {
                        button.classList.add('close-style');
                    }
                    
                    this.elements.quickRepliesContainer.appendChild(button);
                });
                
                this.scrollToBottom();
            }

            /**
             * Clear quick reply buttons
             */
            clearQuickReplies() {
                this.elements.quickRepliesContainer.innerHTML = '';
            }

            /**
             * Handle file attachment
             */
            handleAttachment() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,application/pdf,.txt,.doc,.docx';
                input.style.display = 'none';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.addMessage(`ðŸ“Ž Attached: ${file.name}`, 'user');
                        this.processUserMessage(`I've attached a file: ${file.name}. Can you help me with this?`);
                    }
                    document.body.removeChild(input);
                });
                
                document.body.appendChild(input);
                input.click();
            }

            /**
             * Update connection status
             */
            updateConnectionStatus(status) {
                const { statusDot, statusText, statusMessage } = this.elements;
                
                switch (status) {
                    case 'online':
                        statusDot.className = 'status-dot';
                        statusText.textContent = 'Online';
                        statusMessage.textContent = 'Online';
                        break;
                    case 'failed':
                        statusDot.className = 'status-dot failed';
                        statusText.textContent = 'Connection Failed';
                        statusMessage.textContent = 'Failed';
                        break;
                    case 'connecting':
                        statusDot.className = 'status-dot';
                        statusText.textContent = 'Connecting';
                        statusMessage.textContent = 'Connecting...';
                        break;
                }
            }

            /**
             * Handle API errors with user-friendly messages
             */
            handleAPIError(error) {
                this.updateConnectionStatus('failed');
                console.error("Chatbot API Error:", error);
                
                let errorMessage;
                const errorString = error.message || '';
                
                if (errorString.includes('401')) {
                    errorMessage = "Authentication failed. Please check the API key configuration.";
                } else if (errorString.includes('429')) {
                    errorMessage = "Rate limit exceeded. Please wait a moment and try again.";
                } else if (errorString.includes('500')) {
                    errorMessage = "Server error. Please try again in a few moments.";
                } else if (errorString.includes('Failed to fetch')) {
                    errorMessage = "Network error. Please check your internet connection.";
                } else {
                    errorMessage = "I'm having trouble connecting right now. Please try again.";
                }
                
                this.showErrorMessage(errorMessage);
                this.clearQuickReplies();
                
                // Reset status after delay
                setTimeout(() => {
                    this.updateConnectionStatus('online');
                }, 5000);
            }

            /**
             * Show error message in chat
             */
            showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.innerHTML = `
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <span>${message}</span>
                `;
                
                this.elements.messagesContainer.appendChild(errorDiv);
                this.scrollToBottom();
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 10000);
            }

            /**
             * Scroll messages to bottom
             */
            scrollToBottom() {
                requestAnimationFrame(() => {
                    this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
                });
            }

            /**
             * Public API methods for external control
             */
            open() { this.openChat(); }
            close() { this.closeChat(); }
            
            sendCustomMessage(message, sender = 'user') {
                this.addMessage(message, sender);
                if (sender === 'user') {
                    this.processUserMessage(message);
                }
            }
            
            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                this.applyConfiguration();
            }
        }

        // Initialize the chatbot when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Customization Configuration
            const chatbotConfig = {
                // Basic Settings
                botName: 'AI Assistant',
                botAvatarHeaderUrl: 'https://cdn-icons-png.flaticon.com/256/6819/6819653.png',
                botAvatarMessageUrl: 'https://cdn-icons-png.flaticon.com/256/6819/6819653.png',
                userAvatarUrl: 'https://cdn-icons-png.flaticon.com/256/17878/17878705.png',
                
                // Theme Colors
                primaryColor: '#FF4F8B',
                secondaryColor: '#FF8A4F',
                
                // Messages
                initialMessage: "Hello! I'm your AI assistant powered by advanced language models. How can I help you today?",
                initialQuickReplies: [
                    { text: "Ask a question", message: "I have a question about something" },
                    { text: "Get help", message: "I need help with a task" },
                    { text: "Just chat", message: "I just want to have a conversation" }
                ],
                
                // API Configuration - REPLACE WITH YOUR ACTUAL API KEY
                apiKey: 'OUR_OPENROUTER_API_KEY_HERE',
                apiUrl: 'https://openrouter.ai/api/v1/chat/completions',
                model: 'mistralai/mistral-small-3.2-24b-instruct:free',
                maxTokens: 500,
                temperature: 0.7,
                
                // Feature Settings
                enableAttachments: true,
                enableMarkdown: true,
                autoCloseOnOutsideClick: false, // FIXED: Changed to false to prevent auto-close
                showTypingIndicator: true,
                errorRetryAttempts: 3
            };
            
            // Create the chatbot instance
            window.chatbot = new ChatBot(chatbotConfig);
        });
    </script>
</body>
</html>
